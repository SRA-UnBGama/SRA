<div class="page-header">
  <script type="text/javascript">

      $(document).ready(function () {
          // Ajax to create the options for the type select
          function get_types(value) { // value = place id
              $.ajax({
                  url: "/types/type_by_place",
                  type: "GET",
                  dataType: "json",
                  data: {"id": value},
                  success: function (response) {
                      var select = $("#type select");
                      select.html("");

                      for (var i = 0; i < response.length; i++) {
                          select.append("<option value=" + response[i].id + ">" + response[i].name + "</option>");
                      }
                  },
                  error: function () {
                      console.log("Erro ao buscar type");
                  }
              });
          }

          $('#place select').change(function () {
              var value = $(this).val();

              get_types(value);
          });

          // When the page html is already, set the select option for type base on the first value of the place
          get_types($('#atendimento_place_id').val());
      });

  </script>
</div>

<%= simple_form_for(atendimento, :html => {:class => 'form-horizontal'}) do |f| %>

  <% if atendimento.errors.any? %>
      <div class="alert alert-danger">
        <ul>
          <% atendimento.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
  <% end %>

  <table>
    <tr>
      <th><%= f.label "Nome" %>
        <br/></th>
      <th><%= f.label "Data" %>
        <br/></th>
      <th><%= f.label "Local de Atendimento" %>
        <br/></th>
      <th><%= f.label "Tipo de Atendimento" %>
        <br/></th>
      </br>
    <tr>
      <td>
        <%= User.find_by_id(atendimento.user_id).name %>
      </td>
      <td>
        <%=  l(atendimento.created_at, :format => '%d/%m/%Y %R')%>
      </td>
      <td id='place'>
        <%= f.select :place_id, check_atendimento_place(atendimento.place_id).collect { |p| [p.name, p.id] }, {}, readonly: true %>
      </td>
      <td id="type">
        <%= f.select :type_id, Type.includes(:places).where("places.id" => atendimento.place_id, "active" => true).order('types.name ASC').collect { |t| [t.name, t.id] }, {}, style: "width:30vw" %>
         <script>
          $("#atendimento_type_id").selectize();
        </script>
      </td>
    </tr>
  </table>

  <div class="actions">
    <%if can? :read, Atendimento%>

        <%= link_to raw("<i class=\"icon-white icon-arrow-left\"> Voltar </i>"),
            atendimentos_path, class: "btn  btn-warning"%>

    <% end%>
    
    <%= button_tag :class => 'btn-success btn' do %>
      <i class='fa fa-refresh'></i> Atualizar Atendimento
    <% end %>

  </div>
<% end %>

